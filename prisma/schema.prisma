generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  previewFeatures = ["metrics"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model user {
  id                       Int        @id @default(autoincrement())

  username                 String?     @unique(map: "User_username_key") @db.VarChar(255)
  pw                       String?    @db.VarChar(255)         // local 비밀번호 (없으면 null)

  nick                     String     @unique(map: "User_nick_key") @db.VarChar(50)
  phone                    String?    @unique(map: "User_phone_key") @db.VarChar(30)
  address                  String?    @db.VarChar(400)

  email                    String?    @unique(map: "User_email_key") @db.VarChar(255)
  email_verified_at        DateTime?

  role                     user_role  @default(USER)
  profile_image_url        String?     @db.VarChar(255)
  profile_image_updated_at DateTime?
  is_active                user_is_active @default(Y)

  created_at               DateTime   @default(now())
  updated_at               DateTime   @updatedAt

  // relations
  auth_providers           auth_provider[]
  posts                    post[]
  post_comments            post_comment[]
  post_likes               post_like[]
  stock_watch_list         stock_watch_list[]
  received_notifications   notification[] @relation("ReceivedNotifications")
  actor_notifications      notification[] @relation("ActorNotifications")
  ai_inference_histories   ai_inference_history[]

  @@index([is_active], map: "User_is_active_idx")
}

model auth_provider {
  id                Int      @id @default(autoincrement())
  user_id           Int
  provider           String   @db.VarChar(30) // AuthProvider 타입: 'local' | 'naver' | 'kakao' | 'google' 등
  provider_user_id   String?  @db.VarChar(255) // 소셜 user id (local은 null 가능)
  created_at         DateTime @default(now())
  updated_at         DateTime   @updatedAt

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, provider], map: "AuthProvider_user_provider_unique")              // 한 유저당 provider 1개
  @@unique([provider, provider_user_id], map: "AuthProvider_provider_user_unique")     // 소셜 계정 중복 연결 방지
  @@index([provider], map: "AuthProvider_provider_idx")
  @@index([user_id], map: "AuthProvider_user_id_idx")
}

enum user_role {
  USER
  ADMIN
}

enum user_is_active {
  Y
  N
}

// 카테고리 (post_category) - Enum 형식
enum post_category {
  QUESTION  // 질문
  STOCK     // 종목
  FREE      // 자유
}

// 게시글 (post)
model post {
  id          BigInt       @id @default(autoincrement())
  title       String    @db.VarChar(255)
  content     String    @db.Text
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  deleted_at  DateTime? // null이면 활성, 값이 있으면 삭제됨

  // 카테고리
  category    post_category

  // 작성자 관계
  author_id   Int
  author      user      @relation(fields: [author_id], references: [id], onDelete: Cascade)

  view_count  Int       @default(0)  // 조회수
  comment_count Int     @default(0)  // 댓글 수 (대댓글 포함)
  like_count  Int       @default(0)  // 좋아요 수
  is_pinned   Boolean   @default(false)  // 고정 게시글

  // 댓글 관계
  post_comments post_comment[]

  // 좋아요 관계
  post_likes    post_like[]

  // 인덱스 - 목록 조회 성능 향상
  @@index([category, is_pinned, deleted_at, created_at])
  @@index([deleted_at, created_at])
  @@index([author_id, deleted_at, created_at])
  @@fulltext([title, content]) // 제목과 내용에 대해 전문 검색 인덱스 추가
}

// 미디어 (media) - Firebase URL 저장
model media {
  id          BigInt      @id @default(autoincrement())
  entity_type String      @db.VarChar(50)
  entity_id   BigInt
  url         String      @db.VarChar(2048) // Firebase Storage에서 받은 URL
  mime_type   String?     // image/jpeg, video/mp4 등
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  @@index([entity_type, entity_id])
}

// 게시글 댓글 (post_comment)
model post_comment {
  id         BigInt      @id @default(autoincrement())
  post_id    BigInt
  content    String      @db.Text
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  deleted_at DateTime?

  // 게시글 관계
  post       post        @relation(fields: [post_id], references: [id], onDelete: Cascade)

  // 작성자 관계
  author_id  Int
  author     user        @relation(fields: [author_id], references: [id], onDelete: Cascade)

  // 대댓글 관계 (Self-Relation for 1-level nesting)
  // null이면 최상위 댓글, null이 아니면 해당 ID의 댓글에 대한 대댓글
  parent_id  BigInt?
  parent     post_comment? @relation("PostCommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies    post_comment[] @relation("PostCommentReplies")

  @@index([post_id, created_at, deleted_at]) // 특정 게시글의 댓글 목록 (시간순 정렬)
  @@index([parent_id, deleted_at]) // 대댓글용
  @@index([author_id, deleted_at, created_at]) // 사용자별 댓글용
}

// 게시글 좋아요 (post_like) - 복합 기본 키 사용
model post_like {
  post_id    BigInt
  user_id    Int
  created_at DateTime @default(now())

  // 관계
  post       post     @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // 복합 기본 키
  @@id([post_id, user_id])
  // 사용자별 좋아요 목록 조회 최적화
  @@index([user_id, created_at])
}

model krx_stock_master {
  /// ===== 식별자 =====
  market_code        String   @db.Char(2)   /// KP:코스피, KQ:코스닥, KN:코넥스
  mksc_shrn_iscd     String   @db.Char(9)   /// 단축코드
  /// ===== 구조체 기반 필드 =====
  stnd_iscd          String   @db.Char(12)  /// 표준코드(ISIN)
  hts_kor_isnm       String   @db.VarChar(50) /// 한글 종목명
  scrt_grp_cls_code  String   @db.Char(2)   /// 증권그룹구분(ST, DR, ETF 등)
  avls_scal_cls_code String?   @db.Char(1)   /// 시가총액규모(0~3)
  bstp_larg_div_code String?   @db.Char(4)   /// 업종 대분류
  bstp_medm_div_code String?   @db.Char(4)   /// 업종 중분류
  bstp_smal_div_code String?   @db.Char(4)   /// 업종 소분류
  stck_lstn_date     String?   @db.Char(8)   /// 주식 상장 일자
  nxt_in_master      Boolean   @default(false)      /// 증권사 NXT 종목 마스터 파일 포함 여부 (가공)
  etpr_undt_objt_co_yn Boolean @default(false)      /// 기업인수목적회사여부
  prst_cls_code      String?   @db.Char(1)   /// 우선주 구분 코드 (0:해당없음(보통주), 1:구형우선주, 2:신형우선주, 9:??)
  deleted_at         DateTime? /// 원본에서 삭제된 시각 (배치 기준)
  /// ===== 메타 =====
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  /// ===== 키 =====
  @@id([market_code, mksc_shrn_iscd])
  @@unique([stnd_iscd])
}

model foreign_stock_master {
  // Primary Key
  ncod   String @db.Char(2)   /// National code (US, CN, JP, HK, VN)
  exid   String @db.Char(3)   /// Exchange id (NAS, NYS, HKG, TSE)
  symb   String @db.VarChar(16) /// Symbol (official ticker)
  // Exchange Info
  excd   String @db.Char(3)        /// Exchange code
  exnm   String @db.VarChar(16)    /// Exchange name
  // Realtime Mapping
  rsym   String @db.VarChar(16)    /// Realtime symbol (e.g. NYSAA)
  // Names
  knam   String @db.VarChar(64)    /// Korea name
  enam   String @db.VarChar(64)    /// English name
  // Security Classification
  stis   String @db.Char(1)        /// Security type (1:Index, 2:Stock, 3:ETP, 4:Warrant)
  etyp   String? @db.Char(3)        /// ETP type (001:ETF, 002:ETN, ...)
  isdr   String @db.Char(1)        /// DR flag (Y/N)
  // Classification
  icod   String @db.Char(4)        /// Industry code
  sjong  String @db.Char(1)        /// Index constituent flag (0/1)
  // 메타
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  deleted_at         DateTime? /// 원본에서 삭제된 시각 (배치 기준)

  // 키
  @@id([ncod, exid, symb])
}

model stock_overseas_daily {
  id BigInt @id @default(autoincrement()) // pk, 내부 식별자

  excd String @db.VarChar(4)     // 거래소코드(EXCD, NAS/NYS/AMS 등)
  symb String @db.VarChar(16)    // 종목코드(SYMB, 예: AAPL)

  xymd String @db.Char(8)        // 일자(YYYYMMDD, 거래일 기준)
  clos String @db.VarChar(12)    // 종가(해당 거래일 최종가)
  sign String? @db.Char(1)       // 대비기호(1상한/2상승/3보합/4하한/5하락)
  diff String? @db.VarChar(12)   // 대비(해당일 종가 - 전일 종가)
  rate String? @db.VarChar(12)   // 등락률((대비/종가)*100)
  open String @db.VarChar(12)    // 시가(해당일 최초 체결가)
  high String @db.VarChar(12)    // 고가(해당일 최고 체결가)
  low  String @db.VarChar(12)    // 저가(해당일 최저 체결가)
  tvol String @db.VarChar(14)    // 거래량(해당일 총 거래수량)
  tamt String @db.VarChar(14)    // 거래대금(해당일 총 거래금액)
  pbid String? @db.VarChar(12)   // 매수호가(마지막 체결 시점 기준)
  vbid String? @db.VarChar(10)   // 매수호가잔량(거래량 0일 경우 미수신)
  pask String? @db.VarChar(12)   // 매도호가(마지막 체결 시점 기준)
  vask String? @db.VarChar(10)   // 매도호가잔량(거래량 0일 경우 미수신)

  rsym String @db.VarChar(16)    // 실시간조회종목코드(D+거래소+종목코드)

  created_at DateTime @default(now()) // 데이터 적재 시각(배치 기준)

  @@unique([excd, symb, xymd])   // 거래소+종목+일자 기준 유니크
}

model stock_domestic_daily {
  id Int @id @default(autoincrement())                        // surrogate PK

  mksc_shrn_iscd String @db.VarChar(9)                        // 종목 단축 코드 (예: 005930)
  stck_bsop_date String @db.Char(8)                           // 주식 영업 일자 (YYYYMMDD)

  stck_clpr String? @db.VarChar(10)                           // 주식 종가
  stck_oprc String? @db.VarChar(10)                           // 주식 시가
  stck_hgpr String? @db.VarChar(10)                           // 주식 최고가
  stck_lwpr String? @db.VarChar(10)                           // 주식 최저가

  acml_vol String? @db.VarChar(18)                            // 누적 거래량
  acml_tr_pbmn String? @db.VarChar(18)                        // 누적 거래 대금(원 단위)

  flng_cls_code String? @db.Char(2)                           // 락 구분 코드 (권리락/배당락 등)
  prtt_rate String? @db.VarChar(11)                           // 분할 비율 (기준가/전일 종가)
  mod_yn String? @db.Char(1)                                  // 변경 여부 (시가 없음 등)
  prdy_vrss_sign String? @db.Char(1)                          // 전일 대비 부호
  prdy_vrss String? @db.VarChar(10)                           // 전일 대비
  revl_issu_reas String? @db.Char(2)                          // 재평가 사유 코드

  created_at DateTime @default(now())                         // 생성 시각

  @@unique([mksc_shrn_iscd, stck_bsop_date])                  // 종목 + 영업일 중복 방지
}

model domestic_income_statement { // 국내주식 손익계산서
  id               Int     @id @default(autoincrement())                         // 내부용 PK

  mksc_shrn_iscd   String  @db.Char(9)                                           // 종목코드
  fid_div_cls_code String  @db.Char(1)                                           // 구분 코드: 'Y'=연, 'Q'=분기 (0/1 → 전처리 추천)
  stac_yymm        String  @db.Char(6)                                           // 결산 년월 (예: '202306')

  sale_account     String? @db.VarChar(18)                                       // 매출액
  sale_cost        String? @db.VarChar(182)                                      // 매출 원가
  sale_totl_prfi   String? @db.VarChar(182)                                      // 매출 총 이익
  depr_cost        String? @db.VarChar(182)                                      // 감가상각비 (없는 경우 '99.99')
  sell_mang        String? @db.VarChar(182)                                      // 판매 및 관리비 (없는 경우 '99.99')
  bsop_prti        String? @db.VarChar(182)                                      // 영업 이익
  bsop_non_ernn    String? @db.VarChar(182)                                      // 영업 외 수익 (없는 경우 '99.99')
  bsop_non_expn    String? @db.VarChar(182)                                      // 영업 외 비용 (없는 경우 '99.99')
  op_prfi          String? @db.VarChar(182)                                      // 경상 이익
  spec_prfi        String? @db.VarChar(182)                                      // 특별 이익
  spec_loss        String? @db.VarChar(182)                                      // 특별 손실
  thtr_ntin        String? @db.VarChar(102)                                      // 당기순이익

  created_at       DateTime @default(now())                                      // 생성 시각

  @@unique([mksc_shrn_iscd, fid_div_cls_code, stac_yymm])                        // 종목+구분+기준월 복합 유니크 키
}

model domestic_balance_sheet { // 국내주식 대차대조표
  id               Int     @id @default(autoincrement())                         // 내부용 PK

  mksc_shrn_iscd   String  @db.Char(9)                                           // 종목코드
  fid_div_cls_code String  @db.Char(1)                                           // 구분 코드: 'Y'=연, 'Q'=분기 (0/1 → 전처리 추천)
  stac_yymm        String  @db.Char(6)                                           // 결산 년월 (예: '202306')

  cras             String? @db.VarChar(112)                                      // 유동자산
  fxas             String? @db.VarChar(112)                                      // 고정자산
  total_aset       String? @db.VarChar(102)                                      // 자산총계

  flow_lblt        String? @db.VarChar(112)                                      // 유동부채
  fix_lblt         String? @db.VarChar(112)                                      // 고정부채
  total_lblt       String? @db.VarChar(102)                                      // 부채총계

  cpfn             String? @db.VarChar(22)                                       // 자본금
  cfp_surp         String? @db.VarChar(182)                                      // 자본 잉여금 (없는 경우 '99.99' 등)
  prfi_surp        String? @db.VarChar(182)                                      // 이익 잉여금 (없는 경우 '99.99' 등)
  total_cptl       String? @db.VarChar(102)                                      // 자본총계

  created_at       DateTime @default(now())                                      // 생성 시각

  @@unique([mksc_shrn_iscd, fid_div_cls_code, stac_yymm])                        // 종목+구분+기준월 복합 유니크 키
}

model domestic_stability_ratio { // 국내주식 안정성 비율
  id               Int     @id @default(autoincrement())                         // 내부용 PK

  mksc_shrn_iscd   String  @db.Char(9)                                           // 종목코드
  fid_div_cls_code String  @db.Char(1)                                           // 구분 코드: 'Y'=연, 'Q'=분기 (0/1 → 전처리 추천)
  stac_yymm        String  @db.Char(6)                                           // 결산 년월 (예: '202306')

  lblt_rate        String? @db.VarChar(84)                                       // 부채 비율
  bram_depn        String? @db.VarChar(92)                                       // 차입금 의존도
  crnt_rate        String? @db.VarChar(84)                                       // 유동 비율
  quck_rate        String? @db.VarChar(84)                                       // 당좌 비율

  created_at       DateTime @default(now())                                      // 생성 시각

  @@unique([mksc_shrn_iscd, fid_div_cls_code, stac_yymm])                        // 종목+구분+기준월 복합 유니크 키
}

model domestic_financial_ratio { // 국내주식 재무 비율
  id                 Int     @id @default(autoincrement())                // 기본 PK
  mksc_shrn_iscd     String  @db.Char(9)                                  // 종목코드
  fid_div_cls_code   String  @db.Char(2)                                  // 분류 구분 코드 'Y'=연, 'Q'=분기 (0/1 → 전처리 추천)
  stac_yymm          String  @db.Char(6)                                  // 결산 년월

  grs                String?  @db.VarChar(124)                            // 매출액 증가율
  bsop_prfi_inrt     String?  @db.VarChar(124)                            // 영업 이익 증가율
  ntin_inrt          String?  @db.VarChar(124)                            // 순이익 증가율
  roe_val            String? @db.VarChar(132)                             // ROE 값
  eps                String? @db.VarChar(112)                             // EPS
  sps                String?  @db.VarChar(18)                             // 주당매출액
  bps                String?  @db.VarChar(112)                            // BPS
  rsrv_rate          String?  @db.VarChar(84)                             // 유보 비율
  lblt_rate          String?  @db.VarChar(84)                             // 부채 비율

  created_at         DateTime @default(now())                             // 생성 시각

  @@unique([mksc_shrn_iscd, fid_div_cls_code, stac_yymm])                // 복합 유니크: 종목 + 구분코드 + 결산년월
}

model domestic_financial_summary {
  id                         Int     @id @default(autoincrement())          // 기본 PK
  mksc_shrn_iscd             String  @db.Char(9)                            // 종목코드
  fid_div_cls_code           String  @db.Char(1)                            // 분류 코드 'Y'=연, 'Q'=분기 (0/1 → 전처리 추천)
  stac_yymm                  String  @db.Char(6)                            // 결산 년월 (예: 202309)

  revenue                    String?  @db.VarChar(18)                       // 매출액
  operating_income           String?  @db.VarChar(182)                      // 영업 이익
  net_income                 String?  @db.VarChar(102)                      // 당기순이익
  total_assets               String?  @db.VarChar(102)                      // 자산 총계
  total_liabilities          String?  @db.VarChar(102)                      // 부채 총계
  total_equity               String?  @db.VarChar(102)                      // 자본 총계
  capital_stock              String?  @db.VarChar(22)                       // 자본금
  debt_ratio                 String?  @db.VarChar(84)                       // 부채 비율
  quick_ratio                String?  @db.VarChar(84)                       // 당좌 비율
  retained_earnings_ratio    String?  @db.VarChar(84)                       // 유보 비율
  roe                        String?  @db.VarChar(132)                      // 자기자본이익률 (ROE)
  eps                        String?  @db.VarChar(112)                      // 주당순이익 (EPS)
  bps                        String?  @db.VarChar(112)                      // 주당순자산 (BPS)
  created_at                 DateTime @default(now())                       // 생성 시각

  @@unique([mksc_shrn_iscd, fid_div_cls_code, stac_yymm])                   // 종목코드 + 구분코드 + 결산월 복합 유니크
}

model domestic_bstp_period {
  id               Int @id @default(autoincrement())
  bstp_cls_code    String  @db.Char(4)     // 업종 구분 코드 (길이 확인 필요) 0001: 종합, 1001: 코스닥
  period_div_code  String  @db.Char(1)     // D/W/M/Y
  stck_bsop_date   String  @db.Char(8)     // 기준일자(YYYYMMDD)
  bstp_nmix_prpr   String? @db.VarChar(112) // 현재가
  bstp_nmix_oprc   String? @db.VarChar(112) // 시가
  bstp_nmix_hgpr   String? @db.VarChar(112) // 최고가
  bstp_nmix_lwpr   String? @db.VarChar(112) // 최저가
  acml_vol         String? @db.VarChar(18)  // 누적 거래량
  acml_tr_pbmn     String? @db.VarChar(18)  // 누적 거래 대금(백만단위)
  mod_yn           String? @db.Char(1)      // 변경 여부
  created_at       DateTime @default(now())

  @@unique([bstp_cls_code, period_div_code, stck_bsop_date])
  @@index([stck_bsop_date])
}

// 알림 타입
enum notification_type {
  COMMENT               // 내 글에 댓글
  REPLY                 // 내 댓글에 대댓글
  AI_INFERENCE_COMPLETE // AI 추론 완료
  SYSTEM_NOTICE         // 시스템 공지
}

// 알림 (notification)
model notification {
  id            BigInt            @id @default(autoincrement())

  user_id       Int    // 수신자 (알림 받는 사람)
  user          user              @relation("ReceivedNotifications", fields: [user_id], references: [id], onDelete: Cascade)

  actor_id      Int?    // 발생시킨 사람 (댓글 단 사람 등, 시스템 알림은 null)
  actor         user?             @relation("ActorNotifications", fields: [actor_id], references: [id], onDelete: Cascade)

  type          notification_type   // 알림 종류
  data          Json?   // 추가 데이터 (postId, commentId, inferenceId 등)
  read_at       DateTime?    // 읽음 여부 (null이면 안읽음, 시간이면 읽음)
  created_at    DateTime          @default(now())

  @@index([user_id, created_at(sort: Desc)]) //알림함 조회용 (유저별 최신순)
  @@index([user_id, read_at]) //안읽은 알림 개수 조회용
}

model stock_watch_list {
  user_id    Int
  exchange   String   @db.VarChar(10)
  code       String   @db.VarChar(16)

  sort_order Int      @default(0)
  created_at DateTime @default(now())

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([user_id, exchange, code])
  @@index([user_id, sort_order])
}

model krx_stock_summary {
  mksc_shrn_iscd String   @id @db.Char(9) /// 종목 단축코드 (PK)
  summary        String   @db.Text /// 기업개요
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
}

enum ai_model_type {
  SNAPBACK       // 반등 예측 모델
  QUANT_SIGNAL   // 퀀트 시그널 모델
}

enum inference_status {
  PENDING     // 요청됨, 처리 대기 중
  PROCESSING  // 처리 중
  COMPLETED   // 완료
  FAILED      // 실패
  CANCELED   // 취소
}

model ai_inference_history {
  id             BigInt           @id @default(autoincrement())
  user_id        Int?
  model_type     ai_model_type    // 어떤 AI인지
  model_version  String?          @db.VarChar(20)  // 모델 버전 (선택)
  ticker         String?          @db.VarChar(16)  // 종목코드 (빠른 조회용)
  exchange       String?          @db.VarChar(4)   // 거래소 코드 (KP, KQ, NAS, NYS, AMS)
  request_params Json             // 입력 파라미터 (ticker, date 등)
  response_data  Json?            // 추론 결과 (전체 JSON)
  status         inference_status @default(PENDING)
  latency_ms     Int?             // 추론 소요 시간(ms)
  requested_at   DateTime         @default(now())
  completed_at   DateTime?
  deleted_at     DateTime?        // 사용자 삭제 시점 (null이면 활성)

  user           user?            @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([user_id, model_type, deleted_at, requested_at(sort: Desc)])  // 유저별 모델별 조회
  @@index([user_id, ticker, deleted_at, requested_at(sort: Desc)])      // 유저별 종목별 조회
  @@index([model_type, requested_at(sort: Desc)])                        // 모델별 최신순
  @@index([status, model_type])                                          // 상태별 조회 (모니터링)
}
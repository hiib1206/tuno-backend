generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  previewFeatures = ["metrics"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model kospi_master {
  id                 Int       @id @default(autoincrement())
  mksc_shrn_iscd     String    @unique(map: "mksc_shrn_iscd") @db.VarChar(9)
  stnd_iscd          String    @unique(map: "stnd_iscd") @db.VarChar(12)
  hts_kor_isnm       String    @unique(map: "hts_kor_isnm") @db.VarChar(50)
  scrt_grp_cls_code  String?   @db.VarChar(2)
  avls_scal_cls_code String?   @db.VarChar(1)
  bstp_larg_div_code String?   @db.VarChar(4)
  bstp_medm_div_code String?   @db.VarChar(4)
  bstp_smal_div_code String?   @db.VarChar(4)
  created_at         DateTime? @default(now()) @db.Timestamp(3)
  updated_at         DateTime? @default(now()) @db.Timestamp(3)

  @@index([bstp_larg_div_code], map: "idx_bstp_larg_div_code")
  @@index([scrt_grp_cls_code], map: "idx_scrt_grp_cls_code")
}

model user {
  id                       Int        @id @default(autoincrement())

  username                 String?     @unique(map: "User_username_key") @db.VarChar(255)
  pw                       String?    @db.VarChar(255)         // local 비밀번호 (없으면 null)

  nick                     String     @unique(map: "User_nick_key") @db.VarChar(50)
  phone                    String?    @unique(map: "User_phone_key") @db.VarChar(30)
  address                  String?    @db.VarChar(400)

  email                    String?    @unique(map: "User_email_key") @db.VarChar(255)
  email_verified_at        DateTime?

  role                     user_role  @default(USER)
  profile_image_url        String?     @db.VarChar(255)
  profile_image_updated_at DateTime?
  is_active                user_is_active @default(Y)

  created_at               DateTime   @default(now())
  updated_at               DateTime   @updatedAt

  // relations
  auth_providers           auth_provider[]
  posts                    post[]
  post_comments            post_comment[]
  post_likes               post_like[]

  @@index([is_active], map: "User_is_active_idx")
}

model auth_provider {
  id                Int      @id @default(autoincrement())
  user_id           Int
  provider           String   @db.VarChar(30) // AuthProvider 타입: 'local' | 'naver' | 'kakao' | 'google' 등
  provider_user_id   String?  @db.VarChar(255) // 소셜 user id (local은 null 가능)
  created_at         DateTime @default(now())
  updated_at         DateTime   @updatedAt

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, provider], map: "AuthProvider_user_provider_unique")              // 한 유저당 provider 1개
  @@unique([provider, provider_user_id], map: "AuthProvider_provider_user_unique")     // 소셜 계정 중복 연결 방지
  @@index([provider], map: "AuthProvider_provider_idx")
  @@index([user_id], map: "AuthProvider_user_id_idx")
}

enum user_role {
  USER
  ADMIN
}

enum user_is_active {
  Y
  N
}

// 카테고리 (post_category) - Enum 형식
enum post_category {
  QUESTION  // 질문
  STOCK     // 종목
  FREE      // 자유
}

// 게시글 (post)
model post {
  id          BigInt       @id @default(autoincrement())
  title       String    @db.VarChar(255)
  content     String    @db.Text
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  deleted_at  DateTime? // null이면 활성, 값이 있으면 삭제됨

  // 카테고리
  category    post_category

  // 작성자 관계
  author_id   Int
  author      user      @relation(fields: [author_id], references: [id], onDelete: Cascade)

  view_count  Int       @default(0)  // 조회수
  comment_count Int     @default(0)  // 댓글 수 (대댓글 포함)
  like_count  Int       @default(0)  // 좋아요 수
  is_pinned   Boolean   @default(false)  // 고정 게시글

  // 댓글 관계
  post_comments post_comment[]

  // 좋아요 관계
  post_likes    post_like[]

  // 인덱스 - 목록 조회 성능 향상
  @@index([category, is_pinned, deleted_at, created_at])
  @@index([deleted_at, created_at])
  @@index([author_id, deleted_at, created_at])
  @@fulltext([title, content]) // 제목과 내용에 대해 전문 검색 인덱스 추가
}

// 미디어 (media) - Firebase URL 저장
model media {
  id          BigInt      @id @default(autoincrement())
  entity_type String      @db.VarChar(50)
  entity_id   BigInt
  url         String      @db.VarChar(2048) // Firebase Storage에서 받은 URL
  mime_type   String?     // image/jpeg, video/mp4 등
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt

  @@index([entity_type, entity_id])
}

// 게시글 댓글 (post_comment)
model post_comment {
  id         BigInt      @id @default(autoincrement())
  post_id    BigInt
  content    String      @db.Text
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  deleted_at DateTime?

  // 게시글 관계
  post       post        @relation(fields: [post_id], references: [id], onDelete: Cascade)

  // 작성자 관계
  author_id  Int
  author     user        @relation(fields: [author_id], references: [id], onDelete: Cascade)

  // 대댓글 관계 (Self-Relation for 1-level nesting)
  // null이면 최상위 댓글, null이 아니면 해당 ID의 댓글에 대한 대댓글
  parent_id  BigInt?
  parent     post_comment? @relation("PostCommentReplies", fields: [parent_id], references: [id], onDelete: Cascade)
  replies    post_comment[] @relation("PostCommentReplies")

  @@index([post_id, created_at, deleted_at]) // 특정 게시글의 댓글 목록 (시간순 정렬)
  @@index([parent_id, deleted_at]) // 대댓글용
  @@index([author_id, deleted_at, created_at]) // 사용자별 댓글용
}

// 게시글 좋아요 (post_like) - 복합 기본 키 사용
model post_like {
  post_id    BigInt
  user_id    Int
  created_at DateTime @default(now())

  // 관계
  post       post     @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // 복합 기본 키
  @@id([post_id, user_id])
  // 사용자별 좋아요 목록 조회 최적화
  @@index([user_id, created_at])
}